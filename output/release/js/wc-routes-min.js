;/*2016-5-12 16:26:55*/global._$=global.$=jQuery,wc.extend({app:function(){var app=angular.module("workCloud",["ngRoute"]),initData=function(){app.factory("wcData",function(){return{loadConfig:null}})},initRoute=function(){app.config(["$routeProvider",function($routeProvider){$routeProvider.when("/proj",{
templateUrl:"view/v_proj.html",controller:"c_proj"}).when("/proj_add",{templateUrl:"view/v_proj_add.html",controller:"c_proj_add"}).when("/proj_config",{templateUrl:"view/v_proj_config.html",controller:"c_proj_config"}).when("/plugin",{templateUrl:"view/v_plugin.html",
controller:"c_plugin"}).when("/settings",{templateUrl:"view/v_settings.html",controller:"c_settings"}).otherwise({redirectTo:"/proj_config"})}])},initController=function(){app.controller("c_main",function($scope,wcData){})},init=function(){initData(),initRoute(),
initController()};return init(),app}()}),wc.app.controller("c_plugin",function($scope,wcData){$scope.plugins=[];var listPlugins=$scope.listPlugins=function(){wc.plugin("all",wc.loading).list().then(function(data){data=data.join(" ").match(/\S+@\d.*\d/g),$scope.plugins=$.map(data,function(v,i){
var _plugin=v.split("@");return{name:_plugin[0],version:_plugin[1]}}),$scope.$apply()}).then(function(){bootbox.hideAll(),wc.scroll("ngview")})["catch"](function(data){bootbox.danger(data)})};$scope.install=function(name){wc.plugin(name,wc.loading).install().then(function(){
bootbox.hideAll()})["catch"](function(err){})},$scope.uninstall=function(name){wc.plugin("all",wc.loading).uninstall(name).then(function(){bootbox.hideAll(),setTimeout(function(){bootbox.success("\u5220\u9664\u63d2\u4ef6"+name+"\u6210\u529f")},500),listPlugins();
})["catch"](function(err){setTimeout(function(){bootbox.danger("\u5220\u9664\u63d2\u4ef6"+name+"\u5931\u8d25: "+err)},500),listPlugins()})},listPlugins()}),function(){var Projs=require("./model/projs");wc.app.controller("c_proj",function($scope,wcData){var showDir=wc.showDir;
$scope.createProj=function(projType){wc.modal.dialog({id:"newProj",message:$(".prjDialog"),title:"\u521b\u5efa\u65b0\u9879\u76ee",className:"prjDialog"}),$(".prjDialog").removeClass("hide")},$scope.saveProj=function(isValid){return isValid?void Projs.save([$scope.projName,$("#projList").val(),$scope.projInfo,""],function(result,data){
if($("#subitProj").button("reset"),"success"!=result)return bootbox.hideAll(),setTimeout(function(){bootbox.danger("\u9879\u76ee\u521b\u5efa\u5931\u8d25")},500),!1;wcData.projs[$scope.projName]={name:$scope.projName,src:$("#projList").val(),info:$scope.projInfo,
config:""};var instance=$("#allProjs").jstree(!0),addNode=instance.create_node(instance.element[0].firstChild.firstChild,{text:$scope.projName});wc.modal.hideAll(),$("#createProjForm")[0].reset(),$scope.projName="",$scope.projInfo="",setTimeout(function(){bootbox.success("\u9879\u76ee\u521b\u5efa\u6210\u529f",function(){
instance.select_node(addNode)})},500)}):($("#subitProj").button("reset"),!1)};var loadProj=$scope.loadProj=function(name,isLoadConfig){if(!name||"\u672c\u5730\u9879\u76ee"!=name){if(name&&"all"!=name){if(isLoadConfig)return loadProjConfig(name);$scope.targetProj=wcData.projs[name],
$scope.$apply(),wc.modal.hideAll();var isCurrentProj=!(!$scope.currentProj||$scope.currentProj.name!=name);return void setTimeout(function(){$scope.projInfoDialog||($scope.projInfoDialog=document.getElementById("projInfo"),$scope.projInfoDialog.style.display="block"),
bootbox.dialog({message:$scope.projInfoDialog,title:"\u9879\u76ee\u8be6\u60c5",className:"prjInfoDialog",buttons:{"delete":{label:"\u5220\u9664",className:"btn-danger",callback:function(){deleteProjConfig(name),Projs["delete"](name,function(result,data){bootbox.hideAll(),
setTimeout(function(){bootbox.success("\u9879\u76ee\u5220\u9664\u6210\u529f")},500);var instance=$("#allProjs").jstree(!0);instance.delete_node(instance.get_selected()),delete wcData.projs[name]})}},change:{label:"\u4fee\u6539",className:"btn-warning",callback:function(){
Projs.modify([$("#projInfo .name").val(),$("#projInfo .src").val(),$("#projInfo .info").val(),$scope.targetProj.name],function(result,data){bootbox.hideAll(),"success"==result?setTimeout(function(){bootbox.success("\u9879\u76ee\u4fee\u6539\u6210\u529f\uff01",function(){
loadProjConfig(name,!0)})},500):setTimeout(function(){bootbox.danger("\u9879\u76ee\u4fee\u6539\u5931\u8d25\uff01")},500)})}},load:{label:"\u52a0\u8f7d",className:isCurrentProj?"btn-info hide":"btn-info",callback:function(){return isCurrentProj?(bootbox.hideAll(),
void setTimeout(function(){bootbox.success("\u8be5\u9879\u76ee\u5df2\u7ecf\u52a0\u8f7d\uff01")},500)):(loadProjConfig(name,!0),void bootbox.hideAll())}}}}),$(".src,.info").on("mouseover",function(){var pen=$('<span class="glyphicon glyphicon-pencil"></span>');
$(this).after(pen),$(this).on("mouseout",function(){pen.remove()})})},500)}var renderProjTree=function(data){wcData.projs={};var _prjs={text:"\u672c\u5730\u9879\u76ee",state:{opened:!0},children:[]};$.each(data,function(k,v){wcData.projs[v.name]=v,_prjs.children[k]={
text:v.name}}),showDir(_prjs,"#allProjs"),$("#allProjs").on("changed.jstree",function(e,data){if(data.selected.length)try{var name=data.instance.get_node(data.selected[0]).text;loadProj(name,!1)}catch(e){}})};Projs.getProj(null,function(r,data){renderProjTree(data),
wc.getLocalData("current_proj")&&loadProj(wc.getLocalData("current_proj"),!0)})}},loadProjConfig=function(name){if(name&&wcData.projs[name]){$(".proj-config").slideUp(),$scope.currentProj=wcData.projs[name],$scope.$apply(),wc.setLocalData("current_proj",name);
var src=wcData.projs[name].src;wc.setLocalData("current_src",src),wc.file.readDir(src,showDir),wcData.loadConfig&&wcData.loadConfig(name,src),setTimeout(function(){$(".proj-config").slideDown()},500)}},deleteProjConfig=function(name){name&&wcData.projs[name]&&($scope.currentProj==wcData.projs[name]&&($scope.currentProj=null,
wc.setLocalData("current_proj",""),wc.setLocalData("current_src",""),$scope.$apply(),window.location.href="#/"),wcData.deleteConfig&&wcData.deleteConfig({prj:name}))};loadProj("all"),$("#projList").change(function(e){var dirName=this.value;wc.file.readDir(dirName,showDir);
})}).directive("wcUniqueField",function(){return{require:"ngModel",link:function(scope,ele,attrs,ctrl){var checkTimer;scope.$watch(attrs.ngModel,function(){var name=scope[attrs.ngModel];name&&(checkTimer&&clearTimeout(checkTimer),checkTimer=setTimeout(function(){
Projs.getProj(name,function(r,data){"success"==r&&data?ctrl.$setValidity("unique",!1):ctrl.$setValidity("unique",!0),scope.$apply()})},500))})}}})}(),wc.app.controller("c_proj_add",function($scope,wcData){var Projs=require("./model/projs");wc.showDir;$scope.createProj=function(projType){
$scope.projForm||($scope.projForm=$(".prjDialog")),bootbox.dialog({message:$scope.projForm,title:"\u521b\u5efa\u65b0\u9879\u76ee",className:"prjDialog"}),$("#dialog").show()},$scope.saveProj=function(isValid){return isValid?void Projs.save([$scope.projName,$("#projList").val(),$scope.projInfo,""],function(result,data){
if($("#subitProj").button("reset"),"success"!=result)return!1;wcData.projs[$scope.projName]={name:$scope.projName,src:$("#projList").val(),info:$scope.projInfo,config:""};var instance=$("#allProjs").jstree(!0),addNode=instance.create_node(instance.element[0].firstChild.firstChild,{
text:$scope.projName});bootbox.hideAll(),setTimeout(function(){bootbox.success("\u9879\u76ee\u521b\u5efa\u6210\u529f",function(){instance.select_node(addNode)})},500)}):($("#subitProj").button("reset"),!1)}}),wc.app.controller("c_proj_config",function($scope,wcData){
var Config=require("./model/config"),proj=$scope.proj=wc.getLocalData("current_proj");$scope.showCMD=!1,$scope.showConfigFile=!1;var getConfigCallback=function(result,data){"success"==result&&($scope.allConfigs=data,$scope.$apply())},loadConfig=wcData.loadConfig=function(proj,src){
$scope.proj=wc.getLocalData("current_proj"),Config.getConfig(proj,getConfigCallback)};loadConfig(proj),$scope.run=function(config){config?wc.buildJs(config,wc.log):wc.buildJs({name:$scope.configName,type:$scope.configType,cmdStr:$scope.configCmd,configFile:$("#configFile").val(),
info:$scope.info},wc.log)},$scope.selectConfig=function(configType){"cmd"==configType?($scope.showCMD=!0,$scope.showConfigFile=!1):"gulp"==configType?($scope.showCMD=!1,$scope.showConfigFile=!0):($scope.showCMD=!1,$scope.showConfigFile=!1)};var saveCallBack=function(result,data){
bootbox.success(wc.getLocalData("current_proj")+"\u7684\u914d\u7f6e\u4fdd\u5b58\u6210\u529f",function(){"update success"==result?$scope.$apply():"success"==result&&($scope.allConfigs.push(data),$scope.$apply())})},configCallback=function(index){bootbox.success(wc.getLocalData("current_proj")+"\u7684\u914d\u7f6e\u5220\u9664\u6210\u529f",function(){
$.isNumeric(index)&&($scope.allConfigs.splice(index,1),$scope.$apply())})};$scope["delete"]=wcData.deleteConfig=function(configOption,index){Config["delete"](configOption,function(){configCallback(index)})},$scope.save=function(data){data?Config.modify([data.name,data.type,data.configFile,data.cmdStr,data.info,wc.getLocalData("current_proj"),data.id],saveCallBack):Config.save([$scope.configName,$scope.configType,$("#configFile").val(),$scope.configCmd,$scope.info,wc.getLocalData("current_proj")],saveCallBack);
}}),wc.app.controller("c_settings",function($scope,wcData){$scope.npm={proxy:"",set:function(key,v){switch(key){case"proxy":wc.plugin("npm",wc.loading).proxy(v).then(function(data){bootbox.hideAll()})}}},wc.plugin("npm",wc.loading).proxy().then(function(data){
bootbox.hideAll(),data&&data.length>0&&($scope.npm.proxy=data[0],$scope.$apply())})});